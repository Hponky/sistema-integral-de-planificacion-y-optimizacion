<div class="calculator-container">
  <div class="calculator-content">

    <!-- Header Moderno -->
    <header class="calculator-header-modern">
      <div class="header-content">
        <h1><span>üßÆ </span> <span class="page-title">Calculadora de Dimensionamiento</span></h1>
        <p class="page-subtitle">Optimiza tus recursos bas√°ndote en par√°metros de servicio y tr√°fico</p>
      </div>
    </header>

    <div class="glass-container">
      <!-- Loading Overlay -->
      <div *ngIf="loading" class="loading-overlay">
        <div class="loader-content">
          <div class="loader-svg">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="var(--color-primary-morado)" stroke-width="3" fill="none"
                stroke-dasharray="31.4 31.4" stroke-dashoffset="31.4">
                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1.5s"
                  repeatCount="indefinite" />
              </circle>
              <circle cx="12" cy="12" r="6" stroke="var(--color-primary-naranja)" stroke-width="2" fill="none">
                <animate attributeName="r" values="6;8;6;8;6" dur="1.5s" repeatCount="indefinite" />
              </circle>
            </svg>
          </div>
          <p class="loading-text">Calculando Dimensionamiento</p>
          <p class="loading-subtext">Procesando datos hist√≥ricos y proyecciones...</p>
        </div>
      </div>

      <div *ngIf="flashMessage" class="flash flash-success">
        {{ flashMessage }}
      </div>

      <form (ngSubmit)="onSubmit()" class="calculator-form-modern">
        <!-- Secci√≥n: Plantilla y Servicio -->
        <div class="form-section-modern">
          <div class="section-header">
            <div class="section-icon">üìã</div>
            <h2>Plantilla y Servicio</h2>
          </div>

          <div class="form-grid">
            <div class="form-group-modern">
              <label for="service">
                <span class="label-icon">üìÅ</span>
                Servicio / Campa√±a
              </label>
              <div class="input-wrapper">
                <select id="service" [(ngModel)]="selectedService" (change)="onServiceChange()" name="service"
                  class="form-control-modern" required>
                  <option value="" disabled>Selecciona un servicio</option>
                  <option *ngFor="let service of groupedSegments | keyvalue" [value]="service.key">
                    {{ service.key }}
                  </option>
                </select>
                <div class="select-arrow">‚ñº</div>
              </div>
            </div>

            <div class="form-group-modern">
              <label for="segment">
                <span class="label-icon">üè¢</span>
                Segmento
              </label>
              <div class="input-wrapper">
                <select id="segment" [(ngModel)]="selectedSegment" name="segment" class="form-control-modern" required
                  [disabled]="!selectedService">
                  <option [ngValue]="null" disabled>Selecciona un segmento</option>
                  <option *ngFor="let segment of groupedSegments[selectedService]" [ngValue]="segment.id">
                    {{ segment.name }}
                  </option>
                </select>
                <div class="select-arrow">‚ñº</div>
              </div>
            </div>

            <div class="form-group-modern">
              <label for="start_date">
                <span class="label-icon">üìÖ</span>
                Fecha Inicio
              </label>
              <input type="date" id="start_date" [(ngModel)]="config.start_date" name="start_date"
                class="form-control-modern" required>
            </div>

            <div class="form-group-modern">
              <label for="end_date">
                <span class="label-icon">üìÖ</span>
                Fecha Fin
              </label>
              <input type="date" id="end_date" [(ngModel)]="config.end_date" name="end_date" class="form-control-modern"
                required>
            </div>

            <div class="form-group-modern full-width">
              <label for="plantilla_excel">
                <span class="label-icon">üìÇ</span>
                Archivo de Reductores y AHT
              </label>
              <div class="file-upload-wrapper">
                <input type="file" id="plantilla_excel" (change)="onFileSelected($event)" accept=".xlsx"
                  class="file-input-hidden" required #fileInput>
                <div class="file-upload-control" [class.file-uploaded]="plantillaExcel" (click)="fileInput.click()">
                  <span class="upload-icon">{{ plantillaExcel ? '‚úÖ' : '‚òÅÔ∏è' }}</span>
                  <span class="upload-text">{{ plantillaExcel ? plantillaExcel.name : 'Haz clic para subir tu archivo
                    .xlsx' }}</span>
                  <span class="upload-hint" *ngIf="!plantillaExcel">Hojas requeridas: 'Volumen_a_gestionar',
                    'Llamadas_esperadas'</span>
                  <span class="upload-hint file-size" *ngIf="plantillaExcel">{{ getFileSize(plantillaExcel.size) }} -
                    Clic para cambiar</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Par√°metros de C√°lculo -->
        <div class="form-section-modern">
          <div class="section-header">
            <div class="section-icon">‚öôÔ∏è</div>
            <h2>Par√°metros de C√°lculo</h2>
          </div>

          <div class="form-grid">
            <div class="form-group-modern">
              <label for="sla_objetivo">
                <span class="label-icon">üéØ</span>
                SLA Objetivo
              </label>
              <div class="input-wrapper">
                <input type="number" id="sla_objetivo" [(ngModel)]="config.sla_objetivo" name="sla_objetivo"
                  class="form-control-modern" min="0" max="1" step="0.01" placeholder="Ej. 0.60" required>
              </div>
            </div>

            <div class="form-group-modern">
              <label for="sla_tiempo">
                <span class="label-icon">‚è±Ô∏è</span>
                SLA Tiempo (seg)
              </label>
              <div class="input-wrapper">
                <input type="number" id="sla_tiempo" [(ngModel)]="config.sla_tiempo" name="sla_tiempo"
                  class="form-control-modern" min="1" placeholder="Ej. 20" required>
              </div>
            </div>

            <div class="form-group-modern">
              <label for="nda_objetivo">
                <span class="label-icon">üìâ</span>
                NDA Objetivo
              </label>
              <div class="input-wrapper">
                <input type="number" id="nda_objetivo" [(ngModel)]="config.nda_objetivo" name="nda_objetivo"
                  class="form-control-modern" min="0" max="1" step="0.01" placeholder="Ej. 0.90" required>
              </div>
            </div>

            <div class="form-group-modern">
              <label for="intervalo_seg">
                <span class="label-icon">‚è≥</span>
                Intervalo (seg)
              </label>
              <div class="input-wrapper">
                <input type="number" id="intervalo_seg" [(ngModel)]="config.intervalo_seg" name="intervalo_seg"
                  class="form-control-modern" min="1" placeholder="Ej. 1800" required>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-generate-modern" [disabled]="loading">
            <span class="btn-icon">üöÄ</span>
            Calcular Dimensionamiento
            <div class="btn-ripple"></div>
          </button>
        </div>
      </form>

      <div class="feedback-area">
        <div *ngIf="error" class="error-message">
          <div *ngIf="error?.includes('sesi√≥n expirado')" class="session-expired-notice">
            <p>Tu sesi√≥n ha expirado. Por favor, <a routerLink="/login">inicia sesi√≥n nuevamente</a>.</p>
          </div>
          <div *ngIf="!error?.includes('sesi√≥n expirado')">
            {{ error }}
          </div>
        </div>
      </div>

      <!-- Contenedor para KPIs mejorado con dise√±o moderno -->
      <div *ngIf="results?.kpis" class="kpi-section-modern">
        <div class="kpi-section-header">
          <h3 class="kpi-section-title">M√©tricas Operativas Clave</h3>
          <p class="kpi-section-subtitle">An√°lisis de rendimiento para optimizaci√≥n de recursos</p>
        </div>

        <div class="kpi-grid-modern">
          <!-- KPIs de Reductores -->
          <app-kpi-card [kpiData]="{
            label: '% Absentismo General',
            value: results?.kpis?.absentismo_pct || 0,
            format: 'percentage',
            icon: 'üë•',
            trend: getAbsentismoTrend(results?.kpis?.absentismo_pct),
            color: getAbsentismoColor(results?.kpis?.absentismo_pct)
          }" [animated]="true">
          </app-kpi-card>

          <app-kpi-card [kpiData]="{
            label: '% Auxiliares General',
            value: results?.kpis?.auxiliares_pct || 0,
            format: 'percentage',
            icon: 'üìã',
            trend: getAuxiliaresTrend(results?.kpis?.auxiliares_pct),
            color: getAuxiliaresColor(results?.kpis?.auxiliares_pct)
          }" [animated]="true">
          </app-kpi-card>

          <app-kpi-card [kpiData]="{
            label: '% Desconexiones General',
            value: results?.kpis?.desconexiones_pct || 0,
            format: 'percentage',
            icon: '‚ö°',
            trend: getDesconexionesTrend(results?.kpis?.desconexiones_pct),
            color: getDesconexionesColor(results?.kpis?.desconexiones_pct)
          }" [animated]="true">
          </app-kpi-card>

          <!-- KPIs de Dimensionamiento -->
          <app-kpi-card [kpiData]="{
            label: 'Total Llamadas',
            value: results?.kpis?.total_volumen || 0,
            format: 'number',
            icon: 'üìû',
            color: 'purple'
          }" [animated]="true">
          </app-kpi-card>

          <app-kpi-card [kpiData]="{
            label: 'AHT Promedio (seg)',
            value: results?.kpis?.aht_promedio || 0,
            format: 'number',
            icon: '‚è±Ô∏è',
            color: 'cyan'
          }" [animated]="true">
          </app-kpi-card>

          <app-kpi-card [kpiData]="{
            label: 'Horas Dimensionadas',
            value: results?.kpis?.total_horas_planificadas || 0,
            format: 'number',
            icon: '‚è≥',
            color: 'orange'
          }" [animated]="true">
          </app-kpi-card>

          <app-kpi-card [kpiData]="{
            label: 'FTE Promedio',
            value: results?.kpis?.fte_promedio || 0,
            format: 'number',
            icon: 'üë•',
            color: 'teal'
          }" [animated]="true">
          </app-kpi-card>
        </div>

        <!-- Secci√≥n de insights adicionales -->
        <div class="kpi-insights">
          <div class="insight-card">
            <div class="insight-icon">üí°</div>
            <div class="insight-content">
              <h4>Recomendaci√≥n</h4>
              <p>{{ getInsightMessage(results?.kpis) }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Contenedor para Tablas mejoradas -->
      <div *ngIf="results" class="results-container">
        <app-results-table [tableData]="results.dimensionados" [title]="'Agentes Dimensionados (+ Absentismo)'"
          (sortChange)="onTableSort($event)"></app-results-table>

        <app-results-table [tableData]="results.presentes" [title]="'Agentes Presentes (+ Desconexi√≥n)'"
          (sortChange)="onTableSort($event)"></app-results-table>

        <app-results-table [tableData]="results.logados" [title]="'Agentes Logados (+ Auxiliares)'"
          (sortChange)="onTableSort($event)"></app-results-table>

        <app-results-table [tableData]="results.efectivos" [title]="'Agentes Efectivos (Base Erlang)'"
          (sortChange)="onTableSort($event)"></app-results-table>
      </div>

      <!-- Historial de C√°lculos -->
      <app-calculation-history (onViewDetails)="onViewHistoryDetails($event)"></app-calculation-history>
    </div>
  </div>
</div>